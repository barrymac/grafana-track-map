{"version":3,"sources":["../src/map_ctrl.js"],"names":["_","moment","MetricsPanelCtrl","appEvents","MapCtrl","$scope","$injector","timeSrv","get","myMap","coords","data","panel","maxDataPoints","types","dataType","posField","dataField","tiles","name","url","maxZoom","mapTile","zoom","markerColor","dashboard","events","on","onInitEditMode","bind","render","doMap","minLat","maxLat","minLon","maxLon","k","i","datapoints","length","position","properties","dataPoint","geo","features","geometry","coordinates","lat","lng","Math","min","max","_value","push","value","timestamp","remove","center","find","point","id","L","map","e","coordsInBox","filter","coord","boxZoomBounds","contains","latLng","minTime","apply","maxTime","isFinite","setTime","from","utc","to","layer","tileLayer","addTo","forEach","console","log","marker","color","fillColor","fillOpacity","radius","obj","merge","bindPopup","_toHtml","html","Array","isArray","indexOf","addEditorTab","scope","elem","$panelContainer","bgColor","css","templateUrl"],"mappings":"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","file":"map_ctrl.js","sourcesContent":["import './leaflet.js'\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport './css/map-panel.css!';\r\nimport './leaflet.css!';\r\nimport { MetricsPanelCtrl } from 'app/plugins/sdk';\r\nimport appEvents from 'app/core/app_events';\r\n\r\nvar timeSrv;\r\n\r\nexport class MapCtrl extends MetricsPanelCtrl {\r\n    \r\n    constructor($scope, $injector) {\r\n        super($scope, $injector);\r\n        timeSrv = $injector.get('timeSrv')\r\n        \r\n        this.myMap = null;\r\n        this.coords = [];\r\n        this.data = null;\r\n\r\n        this.panel.maxDataPoints = 1;\r\n        this.panel.types = ['geoJSON','timeserie'];\r\n        this.panel.dataType = this.panel.dataType || this.panel.types[0];\r\n        this.panel.posField = this.panel.posField || '';\r\n        this.panel.dataField = this.panel.dataField || '';\r\n        this.panel.tiles = [\r\n            { name: 'openstreet', url: '//tile.openstreetmap.org/{z}/{x}/{y}.png', maxZoom: 18}, \r\n            { name: 'opentopomap', url: '//{s}.tile.opentopomap.org/{z}/{x}/{y}.png', maxZoom: 17}, \r\n            { name: 'opencyclemap', url: '//a.tile3.opencyclemap.org/landscape/{z}/{x}/{y}.png'}\r\n        ];\r\n        this.panel.mapTile = this.panel.mapTile || this.panel.tiles[0];\r\n        this.panel.zoom = this.panel.zoom || 12;\r\n        this.panel.markerColor = this.panel.markerColor || 'red';\r\n        const dashboard = this.dashboard;\r\n        \r\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n        \r\n//        this.events.on('panel-teardown', this.onPanelTeardown.bind(this));\r\n        \r\n        this.events.on('panel-initialized', this.render.bind(this));\r\n        \r\n        this.events.on('data-received', (data) => {\r\n            this.data = data;\r\n            this.doMap();\r\n        });\r\n    }\r\n    \r\n    doMap() {\r\n        var data = this.data;\r\n        var panel = this.panel;\r\n        this.coords = [];\r\n        var minLat = 41.1432592728;\r\n        var maxLat = 47.247324252;\r\n        var minLon = 6.098126173;\r\n        var maxLon = 5.4859435558;\r\n        \r\n        for (var k in data) {\r\n            for (var i = 0; i < data[k].datapoints.length; i++) {\r\n                var position, properties;\r\n                if (this.panel.dataType==\"geoJSON\") {\r\n                //if (data[k].datapoints[i][0].type && data[k].datapoints[i][0].type=='Feature') {\r\n                    // coordinates field of geoJSON\r\n                    var dataPoint = data[k].datapoints[i][0];\r\n                    if (this.panel.posField) {\r\n                        var geo = _.get(dataPoint, this.panel.posField);    // lodash _.get(object, path, [defaultValue])\r\n                        position = geo.features[0].geometry.coordinates;\r\n                        properties = geo.features[0].properties;\r\n                    } else {\r\n                        position = dataPoint.features[0].geometry.coordinates;\r\n                        properties = dataPoint.features[0].properties;\r\n                    }\r\n                    if (position && position[0]) {\r\n                        position = {lat: position[1], lng: position[0]};\r\n                        minLat = Math.min(minLat, position.lat);\r\n                        minLon = Math.min(minLon, position.lng);\r\n                        maxLat = Math.max(maxLat, position.lat);\r\n                        maxLon = Math.max(maxLon, position.lng);\r\n                    }\r\n                    if (this.panel.dataField) {\r\n                        var _value = _.get(dataPoint, this.panel.dataField);    // lodash _.get(object, path, [defaultValue])\r\n                    } else\r\n                        _value = null;\r\n                    this.coords.push({\r\n                        value: _value,\r\n                        position: position,\r\n                        timestamp: data[k].datapoints[i][1],\r\n                        properties: properties\r\n                    });\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this.myMap) {\r\n            this.myMap.remove();\r\n        }\r\n        var center = this.coords.find(point => point.position);\r\n        center = center ? center.position : [0, 0];\r\n        var id = \"map_\"+this.panel.id;\r\n        this.myMap = L.map(id, {\r\n            center: center,\r\n            zoom: this.panel.zoom\r\n        });\r\n        \r\n        //this.myMap.fitBounds([[minLat, minLon], [maxLat, maxLon]]);\r\n\r\n        this.myMap.on(\"boxzoomend\", function (e) {\r\n            const coordsInBox = this.coords.filter(coord =>\r\n                coord.position && e.boxZoomBounds.contains(L.latLng(coord.position.lat, coord.position.lng))\r\n            );\r\n            const minTime = Math.min.apply(Math, coordsInBox.map(coord => coord.timestamp));\r\n            const maxTime = Math.max.apply(Math, coordsInBox.map(coord => coord.timestamp));\r\n\r\n            if (isFinite(minTime) && isFinite(maxTime)) {\r\n                timeSrv.setTime({\r\n                    from: moment.utc(minTime),\r\n                    to: moment.utc(maxTime),\r\n                });\r\n            }\r\n        });\r\n\r\n        var layer = L.tileLayer(panel.mapTile.url, {\r\n            maxZoom: panel.mapTile.maxZoom,\r\n        });\r\n        layer.addTo(this.myMap);\r\n\r\n        this.coords.forEach(point => {\r\n            console.log(\"point\", point);\r\n            if (point.position) {\r\n                //point.marker = L.circleMarker(point.position, {\r\n                point.marker = L.marker(point.position, {\r\n                    color: panel.markerColor,\r\n                    //stroke: 'false',\r\n                    fillColor: 'none',\r\n                    fillOpacity: 0.5,\r\n                    radius: 10\r\n                });\r\n                point.marker.addTo(this.myMap);\r\n                var obj = _.merge({ value: point.value }, point.properties)\r\n                point.marker.bindPopup(this._toHtml(obj));\r\n            }\r\n        });\r\n    }\r\n    \r\n    _toHtml(obj) {\r\n        var html = \"\";\r\n        for (var k in obj) {\r\n            if (obj[k] && !Array.isArray(obj[k])) {\r\n                html += \"<div class='prop'>\";\r\n                html += \"<b>\"+k+\"</b>: \";\r\n                if (typeof obj[k]=='string' && obj[k].indexOf(\"http\")!=-1) {\r\n                    html += \"<a href='\"+obj[k]+\"' target='_blank'>\"+obj[k]+\"</a>: \";\r\n                } else {\r\n                    html += obj[k];\r\n                }\r\n                html += \"</div>\";\r\n            }\r\n        }\r\n        return html;\r\n    }\r\n\r\n    doMapAndRender() {\r\n        this.doMap();\r\n        this.render();\r\n    }\r\n\r\n    onInitEditMode() {\r\n        this.addEditorTab('Options', 'public/plugins/grafana-map-panel/editor.html', 2);\r\n    }\r\n\r\n//    onPanelTeardown() {\r\n//        this.$timeout.cancel(this.nextTickPromise);\r\n//    }\r\n\r\n    link(scope, elem) {\r\n        this.events.on('render', () => {\r\n\r\n            const $panelContainer = elem.find('.panel-container');\r\n\r\n            if (this.panel.bgColor) {\r\n                $panelContainer.css('background-color', this.panel.bgColor);\r\n            } else {\r\n                $panelContainer.css('background-color', '');\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nMapCtrl.templateUrl = 'module.html';\r\n"]}