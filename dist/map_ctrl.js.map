{"version":3,"sources":["../src/map_ctrl.js"],"names":["_","moment","MetricsPanelCtrl","appEvents","MapCtrl","$scope","$injector","timeSrv","get","myMap","coords","data","panel","maxDataPoints","types","dataType","latField","lngField","posField","dataField","Array","isArray","dataLabel","linkPanel","showProps","tiles","name","url","maxZoom","tileList","map","item","mapTile","zoom","circle","circleColor","markerColor","events","on","onInitEditMode","bind","render","doMap","minLat","maxLat","minLon","maxLon","k","target","targets","console","log","datapoints","length","i","position","properties","values","ts","dataPoint","geo","features","geometry","coordinates","latitude","lat","lng","longitude","Math","min","max","z","push","timestamp","remove","points","point","id","bounds","L","latLngBounds","center","getCenter","fitBounds","e","coordsInBox","filter","coord","boxZoomBounds","contains","latLng","minTime","apply","maxTime","isFinite","setTime","from","utc","to","find","layer","tileLayer","addTo","forEach","marker","circleMarker","color","fillColor","fillOpacity","radius","title","customIcon","icon","iconUrl","iconSize","obj","date","label","value","merge","html","_toHtml","_findPanelByTarget","ts_range","timeRange","valueOf","dashboard","bindPopup","indexOf","isMoment","format","r","rows","p","panels","type","key","splice","doMapAndRender","addEditorTab","scope","elem","$panelContainer","bgColor","css","templateUrl"],"mappings":"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","file":"map_ctrl.js","sourcesContent":["import './leaflet.js'\r\nimport _ from 'lodash';\r\nimport moment from 'moment';\r\nimport './css/map-panel.css!';\r\nimport './leaflet.css!';\r\nimport { MetricsPanelCtrl } from 'app/plugins/sdk';\r\nimport appEvents from 'app/core/app_events';\r\n\r\nvar timeSrv;\r\n\r\nexport class MapCtrl extends MetricsPanelCtrl {\r\n    \r\n    constructor($scope, $injector) {\r\n        super($scope, $injector);\r\n        timeSrv = $injector.get('timeSrv')\r\n        \r\n        this.myMap = null;\r\n        this.coords = [];\r\n        this.data = null;\r\n\r\n        this.panel.maxDataPoints = 1;\r\n        this.panel.types = ['geoJSON','custom'];\r\n        this.panel.dataType = this.panel.dataType || this.panel.types[0];\r\n        this.panel.latField = this.panel.latField || null;\r\n        this.panel.lngField = this.panel.lngField || null;\r\n        this.panel.posField = this.panel.posField || '';\r\n        if (this.panel.dataField && !Array.isArray(this.panel.dataField)) this.panel.dataField = [this.panel.dataField];\r\n        if (this.panel.dataLabel && !Array.isArray(this.panel.dataLabel)) this.panel.dataLabel = [this.panel.dataLabel];\r\n        this.panel.dataField = this.panel.dataField || [''];\r\n        this.panel.dataLabel = this.panel.dataLabel || ['value'];\r\n        this.panel.linkPanel = this.panel.linkPanel || false;\r\n        this.panel.showProps = this.panel.showProps || false;\r\n        this.panel.tiles = [\r\n            { name: 'openstreet', url: '//tile.openstreetmap.org/{z}/{x}/{y}.png', maxZoom: 18}, \r\n            { name: 'opentopomap', url: '//{s}.tile.opentopomap.org/{z}/{x}/{y}.png', maxZoom: 17}, \r\n            { name: 'opencyclemap', url: '//{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png'},\r\n            { name: 'opencyclemap_transport', url: '//{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png'},\r\n            { name: 'opencyclemap_outdoors', url: '//{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png'},\r\n            { name: 'mapquest_aerial', url: '//tileproxy.cloud.mapquest.com/tiles/1.0.0/hyb/{z}/{x}/{y}.png', maxZoom: 18}, \r\n        ];\r\n        this.panel.tileList = this.panel.tiles.map(function(item) {\r\n            return item.name;\r\n        }, []);\r\n        this.panel.mapTile = this.panel.mapTile || this.panel.tileList[0];\r\n        this.panel.zoom = this.panel.zoom || 12;\r\n        this.panel.circle = this.panel.circle || false;\r\n        this.panel.circleColor = this.panel.circleColor || 'red';\r\n        this.panel.markerColor = this.panel.markerColor || 'default';\r\n                \r\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\r\n        \r\n        this.events.on('panel-initialized', this.render.bind(this));\r\n        \r\n        this.events.on('data-received', (data) => {\r\n            this.data = data;\r\n            this.doMap();\r\n        });\r\n    }\r\n    \r\n    doMap() {\r\n        var data = this.data;\r\n        var panel = this.panel;\r\n        this.coords = [];\r\n        var minLat = 41.1432592728;\r\n        var maxLat = 47.247324252;\r\n        var minLon = 6.098126173;\r\n        var maxLon = 5.4859435558;\r\n        \r\n        for (var k in data) {\r\n            var target = this.panel.targets[k].target;\r\n            console.log(\"data \"+k+\" target: \",target);\r\n            if (data[k].datapoints) {\r\n                console.log(\"   >datapoints: \",data[k].datapoints.length);\r\n                for (var i = 0; i < data[k].datapoints.length; i++) {\r\n                    // position\r\n                    var position, properties, values = [], ts;\r\n                    if (data[k].datapoints[i] && data[k].datapoints[i][1]) ts = data[k].datapoints[i][1];\r\n                    if (this.panel.dataType==\"geoJSON\") {\r\n                        // coordinates field of geoJSON\r\n                        var dataPoint = data[k].datapoints[i][0];\r\n                        if (this.panel.posField) {\r\n                            var geo = _.get(dataPoint, this.panel.posField);    // lodash _.get(object, path, [defaultValue])\r\n                            position = geo.features[0].geometry.coordinates;\r\n                            if (this.panel.showProps) properties = geo.features[0].properties;\r\n                        } else if (dataPoint && dataPoint.features) {\r\n                            position = dataPoint.features[0].geometry.coordinates;\r\n                            if (this.panel.showProps) properties = dataPoint.features[0].properties;\r\n                        } else if (dataPoint && (dataPoint.latitude || dataPoint.lat)) {\r\n                            var lat = dataPoint.latitude || dataPoint.lat;\r\n                            var lng = dataPoint.longitude || dataPoint.lng;\r\n                            position = {lat: lat, lng: lng};\r\n                            properties = {};\r\n                        } else {\r\n                            // nothing\r\n                        }\r\n                        if (position) {\r\n                            position = {lat: position[1], lng: position[0]};\r\n                            minLat = Math.min(minLat, position.lat);\r\n                            minLon = Math.min(minLon, position.lng);\r\n                            maxLat = Math.max(maxLat, position.lat);\r\n                            maxLon = Math.max(maxLon, position.lng);\r\n                        }\r\n                    } else if (this.panel.dataType==\"custom\") {\r\n                        var dataPoint = data[k].datapoints[i][0];\r\n                        if (this.panel.latField && this.panel.lngField) {\r\n                            var lat = _.get(dataPoint, this.panel.latField);\r\n                            var lng = _.get(dataPoint, this.panel.lngField);\r\n                            position = {lat: lat, lng: lng};\r\n                            properties = {};\r\n                        } else if (dataPoint && (dataPoint.latitude || dataPoint.lat)) {\r\n                            var lat = dataPoint.latitude || dataPoint.lat;\r\n                            var lng = dataPoint.longitude || dataPoint.lng;\r\n                            position = {lat: lat, lng: lng};\r\n                            properties = {};\r\n                        } else {\r\n                            // nothing\r\n                        }\r\n                    }\r\n                    // datafield\r\n                    if (this.panel.dataField) {\r\n                        if (Array.isArray(this.panel.dataField)) {\r\n                            // multiple values\r\n                            for (var z in this.panel.dataField) {\r\n                                values.push({ 'label': this.panel.dataLabel[z], 'value': _.get(dataPoint, this.panel.dataField[z])});\r\n                            }\r\n                        } else {\r\n                            // single value\r\n                            values.push({ 'label': this.panel.dataLabel, 'value': _.get(dataPoint, this.panel.dataField)});\r\n                        }\r\n                    } else {\r\n                        values = [];\r\n                    }\r\n                    this.coords.push({\r\n                        values: values,\r\n                        position: position,\r\n                        timestamp: ts,\r\n                        properties: properties,\r\n                        target: target\r\n                    });\r\n                }\r\n            } else {\r\n                console.log(\"doMap - no datapoint for \"+k);\r\n            }\r\n        }\r\n\r\n        if (this.myMap) {\r\n            this.myMap.remove();\r\n        }\r\n        var points = this.coords.map(function(point) {\r\n            return point.position;\r\n        }, []);\r\n        var id = \"map_\"+this.panel.id;\r\n        if (points.length>0) {\r\n            var bounds = L.latLngBounds(points);\r\n            var center = bounds.getCenter();\r\n            var zoom = this.panel.zoom;\r\n            this.myMap = L.map(id, {\r\n                center: center,\r\n                zoom: zoom\r\n            });\r\n            console.log(\"OK map for \"+k+\" target: \",target);\r\n        } else {\r\n            // no points\r\n//            bounds = L.latLngBounds([\r\n//                [47.043706416, 6.5799864891],\r\n//                [36.4616233749, 18.5032287476]\r\n//            ]);\r\n            //this.myMap = L.map(id);\r\n            console.log(\"NO map for \"+k+\" target: \",target);\r\n            return;\r\n        }\r\n        try {\r\n            if (points.length>1) this.myMap.fitBounds(bounds);\r\n        } catch(e) {\r\n            console.log(\"error fitBounds\", e)\r\n        }\r\n        \r\n        this.myMap.on(\"boxzoomend\", function (e) {\r\n            const coordsInBox = this.coords.filter(coord =>\r\n                coord.position && e.boxZoomBounds.contains(L.latLng(coord.position.lat, coord.position.lng))\r\n            );\r\n            const minTime = Math.min.apply(Math, coordsInBox.map(coord => coord.timestamp));\r\n            const maxTime = Math.max.apply(Math, coordsInBox.map(coord => coord.timestamp));\r\n\r\n            if (isFinite(minTime) && isFinite(maxTime)) {\r\n                timeSrv.setTime({\r\n                    from: moment.utc(minTime),\r\n                    to: moment.utc(maxTime),\r\n                });\r\n            }\r\n        });\r\n\r\n        var mapTile = _.find(this.panel.tiles, ['name', this.panel.mapTile]);\r\n        var layer = L.tileLayer(mapTile.url, {\r\n            maxZoom: mapTile.maxZoom,\r\n        });\r\n        layer.addTo(this.myMap);\r\n\r\n        this.coords.forEach(point => {\r\n            //console.log(\"point\", point);\r\n            if (point.position) {\r\n                if (this.panel.circle) {\r\n                    point.marker = L.circleMarker(point.position, {\r\n                        color: this.panel.circleColor,\r\n                        //stroke: 'false',\r\n                        fillColor: 'none',\r\n                        fillOpacity: 0.5,\r\n                        radius: 10,\r\n                        title: point.target\r\n                    });                    \r\n                } else {\r\n                    // marker\r\n                    var marker = this.panel.markerColor=='default' ? \"\" : \"-\"+this.panel.markerColor;\r\n                    var customIcon = L.icon({\r\n                        iconUrl: '/grafana/public/plugins/grafana-map-panel/images/marker-icon'+marker+'.png',\r\n                        iconSize: [25, 41], // size of the icon\r\n                    });\r\n                    point.marker = L.marker(point.position, {\r\n                        icon: customIcon,\r\n                        title: point.target\r\n                    });\r\n                }\r\n                point.marker.addTo(this.myMap);\r\n                var obj = { date: moment(point.timestamp) };\r\n                for (var k in point.values) {\r\n                    obj[point.values[k].label] = point.values[k].value;\r\n                }\r\n                obj = _.merge(obj, point.properties)\r\n                var html = this._toHtml(obj);\r\n                var panel = point.target ? this._findPanelByTarget(point.target) : null;\r\n                console.log(\"point > panel\", panel);\r\n                if (this.panel.linkPanel && panel) {\r\n                    var ts_range = \"&from=\"+timeSrv.timeRange().from.valueOf()+\"&to=\"+timeSrv.timeRange().to.valueOf();\r\n                    var url = \"/grafana/dashboard-solo/db/\"+this.dashboard.title+\"?panelId=\"+panel.id+\"&theme=light\"+ts_range;\r\n                    html += \"<div class='link-panel'>\";\r\n                    html += \"<hr><b>Data Graph for \"+point.target+\"</b>\";\r\n                    //html += \"<a class='link-panel' href='\"+panel.id+\"'>panel \"+panel.id+\"</>\";\r\n                    html += \"<iframe src='\"+url+\"' class='link-panel'></iframe>\";\r\n                    html += \"</div>\";\r\n                }\r\n                point.marker.bindPopup(html);\r\n            }\r\n        });\r\n    }\r\n    \r\n    _toHtml(obj) {\r\n        var html = \"\";\r\n        for (var k in obj) {\r\n            if (obj[k] && !Array.isArray(obj[k])) {\r\n                html += \"<div class='prop'>\";\r\n                html += \"<b>\"+k+\"</b>: \";\r\n                if (typeof obj[k]=='string' && obj[k].indexOf(\"http\")!=-1) {\r\n                    html += \"<a href='\"+obj[k]+\"' target='_blank'>\"+obj[k]+\"</a>: \";\r\n                } else if(moment.isMoment(obj[k])) {\r\n                    html += obj[k].format('DD/MM/YYYY hh:mm:ss');\r\n                } else {\r\n                    html += obj[k];\r\n                }\r\n                html += \"</div>\";\r\n            }\r\n        }\r\n        return html;\r\n    }\r\n    \r\n    _findPanelByTarget(target) {\r\n        for (var r in this.dashboard.rows) {\r\n            for (var p in this.dashboard.rows[r].panels) {\r\n                var panel = this.dashboard.rows[r].panels[p];\r\n                if (panel.targets[\"0\"].target==target && panel.type==\"graph\") {\r\n                    return panel;\r\n                }\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    addDataField() {\r\n        console.log('addDataField');\r\n        this.panel.dataField.push('');\r\n        this.panel.dataLabel.push('value');\r\n    }\r\n    \r\n    removeDataField(key) {\r\n        console.log('removeDataField: '+key);\r\n        this.panel.dataField.splice(key, 1);\r\n        this.panel.dataLabel.splice(key, 1);\r\n        this.doMapAndRender();\r\n    }\r\n\r\n    doMapAndRender() {\r\n        this.doMap();\r\n        this.render();\r\n    }\r\n\r\n    onInitEditMode() {\r\n        this.addEditorTab('Options', 'public/plugins/grafana-map-panel/editor.html', 2);\r\n    }\r\n\r\n    addPanel() {\r\n        console.log(\"dashboard\",this.dashboard);\r\n        console.log(\"panel\",this.panel);\r\n        \r\n//        this.dashboard.rows[\"0\"].panels[\"0\"].targets[\"0\"].target\r\n\r\n    }\r\n       \r\n    link(scope, elem) {\r\n        this.events.on('render', () => {\r\n\r\n            const $panelContainer = elem.find('.panel-container');\r\n\r\n            if (this.panel.bgColor) {\r\n                $panelContainer.css('background-color', this.panel.bgColor);\r\n            } else {\r\n                $panelContainer.css('background-color', '');\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nMapCtrl.templateUrl = 'module.html';\r\n"]}